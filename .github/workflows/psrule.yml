name: Github PSRules check

on:
  pull_request:
    branches: [main]
   
jobs:
        
  main:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
        
    - name: PowerShell script
      # You may pin to the exact commit or the version.
      # uses: Amadevus/pwsh-script@1f1751bbf3d1a92127bfc6c32403283625880cbf
      uses: Amadevus/pwsh-script@v2.0.1
      with:
        # PowerShell script to execute in Actions-hydrated context
        script: |
          Install-Module -Name 'PSRule.Rules.GitHub' -Scope CurrentUser -Force;
          Export-GitHubRuleData;
          Assert-PSRule -Module 'PSRule.Rules.GitHub' -InputPath .\*.json -Style GitHubActions -OutputFormat Sarif -OutputPath reports/ps-rule-results.sarif;
          
    - name: Upload results to security tab
      if: success() || failure()
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: reports/ps-rule-results.sarif
        
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    # Analyze Azure resources using PSRule for Azure
    - name: Analyze Azure template files
      uses: microsoft/ps-rule@v2.2.0
      with:
        modules: 'PSRule.Rules.GitHub'
